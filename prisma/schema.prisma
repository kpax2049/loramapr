generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "darwin-arm64", "linux-arm64-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id         String    @id @default(uuid()) @db.Uuid
  email      String?
  createdAt  DateTime  @default(now())
  disabledAt DateTime?

  devices  Device[]
  sessions Session[]
  apiKeys  ApiKey[]
}

model Device {
  id         String    @id @default(uuid()) @db.Uuid
  deviceUid  String    @unique
  name       String?
  notes      String?
  meshtasticNodeId String?
  hwModel    String?
  firmwareVersion String?
  appVersion String?
  longName   String?
  shortName  String?
  macaddr    String?
  publicKey  String?
  isUnmessagable Boolean?
  role       String?
  lastNodeInfoAt DateTime?
  iconKey    String?
  iconOverride Boolean @default(false)
  isArchived Boolean   @default(false)
  ownerId    String?   @db.Uuid
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  lastSeenAt DateTime?

  owner        User?         @relation(fields: [ownerId], references: [id])
  sessions     Session[]
  measurements Measurement[]
  telemetrySamples DeviceTelemetrySample[]
  coverageBins CoverageBin[]
  agentDecisions AgentDecision[]
  autoSessionConfig DeviceAutoSessionConfig?

  @@index([deviceUid])
}

model Session {
  id        String   @id @default(uuid()) @db.Uuid
  deviceId  String   @db.Uuid
  ownerId   String?  @db.Uuid
  name      String?
  startedAt DateTime
  endedAt   DateTime?
  notes     String?
  isArchived Boolean @default(false)
  archivedAt DateTime?
  updatedAt DateTime @updatedAt

  device       Device        @relation(fields: [deviceId], references: [id])
  owner        User?          @relation(fields: [ownerId], references: [id])
  measurements Measurement[]
  coverageBins CoverageBin[]

  @@index([deviceId, startedAt])
}

model Measurement {
  id         String   @id @default(uuid()) @db.Uuid
  deviceId   String   @db.Uuid
  sessionId  String?  @db.Uuid
  capturedAt DateTime
  lat        Float
  lon        Float
  alt        Float?
  hdop       Float?
  rssi       Int?
  snr        Float?
  sf         Int?
  bw         Int?
  freq       Float?
  gatewayId  String?
  payloadRaw String?
  rxMetadata Json?
  ingestedAt DateTime @default(now())

  device         Device        @relation(fields: [deviceId], references: [id])
  session        Session?      @relation(fields: [sessionId], references: [id])
  rxMetadataRows RxMetadata[]

  @@index([deviceId, capturedAt(sort: Desc)])
  @@index([sessionId, capturedAt(sort: Desc)])
  @@index([sessionId])
  @@index([gatewayId])
}

model RxMetadata {
  id             String      @id @default(uuid()) @db.Uuid
  measurementId  String      @db.Uuid
  gatewayId      String
  rssi           Int?
  snr            Float?
  channelIndex   Int?
  time           DateTime?
  fineTimestamp  Int?
  receivedAt     DateTime    @default(now())

  measurement Measurement @relation(fields: [measurementId], references: [id], onDelete: Cascade)

  @@index([gatewayId, receivedAt])
  @@index([measurementId])
  @@index([gatewayId, measurementId])
  @@index([receivedAt])
  @@unique([measurementId, gatewayId])
}

model ApiKey {
  id        String       @id @default(uuid()) @db.Uuid
  keyHash   String
  label     String?
  scopes    ApiKeyScope[]
  ownerId   String?      @db.Uuid
  createdAt DateTime     @default(now())
  revokedAt DateTime?

  owner User? @relation(fields: [ownerId], references: [id])
}

enum ApiKeyScope {
  INGEST
  QUERY
}

enum WebhookEventSource {
  MESHTASTIC
  LORAWAN
  AGENT
  SIM
}

model LorawanUplink {
  id         String   @id @default(uuid()) @db.Uuid
  payloadRaw Json
  receivedAt DateTime @default(now())
}

model WebhookEvent {
  id         String   @id @default(uuid()) @db.Uuid
  source     WebhookEventSource
  receivedAt DateTime @default(now())
  payloadJson Json @map("payload")
  processingStartedAt DateTime?
  processingWorkerId String?
  processedAt DateTime?
  error      String? @map("processingError")
  eventType  String?
  deviceUid  String?
  portnum    String?
  packetId   String?  @unique @map("uplinkId")

  @@index([receivedAt])
  @@index([processedAt])
  @@index([source, receivedAt(sort: Desc)])
  @@index([deviceUid])
  @@index([deviceUid, receivedAt(sort: Desc)])
  @@index([portnum, receivedAt(sort: Desc)])
}

model CoverageBin {
  id        String   @id @default(uuid()) @db.Uuid
  deviceId  String   @db.Uuid
  sessionId String?  @db.Uuid
  gatewayId String?
  day       DateTime
  latBin    Int
  lonBin    Int
  count     Int
  rssiAvg   Float?
  snrAvg    Float?
  rssiMin   Int?
  rssiMax   Int?
  snrMin    Float?
  snrMax    Float?
  updatedAt DateTime @updatedAt

  device  Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  session Session? @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([deviceId, day])
  @@index([sessionId, day])
  @@index([gatewayId, day])
  @@unique([deviceId, sessionId, gatewayId, day, latBin, lonBin])
}

model AgentDecision {
  id         String   @id @default(uuid()) @db.Uuid
  deviceId   String   @db.Uuid
  deviceUid  String
  decision   String
  reason     String?
  inside     Boolean?
  distanceM  Float?
  capturedAt DateTime?
  createdAt  DateTime @default(now())

  device Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([deviceId, createdAt])
}

model DeviceTelemetrySample {
  id                String   @id @default(uuid()) @db.Uuid
  deviceId          String   @db.Uuid
  device            Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  capturedAt        DateTime
  source            String

  batteryLevel      Int?
  voltage           Float?
  channelUtilization Float?
  airUtilTx         Float?
  uptimeSeconds     Int?

  raw               Json?

  createdAt         DateTime @default(now())

  @@index([deviceId, capturedAt])
  @@index([capturedAt])
}

model DeviceAutoSessionConfig {
  id               String   @id @default(uuid()) @db.Uuid
  deviceId         String   @unique @db.Uuid
  device           Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  enabled          Boolean  @default(false)

  homeLat          Float?
  homeLon          Float?
  radiusMeters     Int?

  minOutsideSeconds Int?
  minInsideSeconds  Int?

  updatedAt        DateTime @updatedAt
}
