#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

COMPOSE=(docker compose)

die() {
  echo "ERROR: $*" >&2
  exit 1
}

usage() {
  cat <<'EOF'
Usage:
  ./bin/loramapr up|down|logs|ps|reset|demo|keys

Commands:
  up      Start docker compose stack
  down    Stop docker compose stack
  logs    Tail docker compose logs
  ps      Show docker compose services
  reset   Stop stack and remove volumes (destructive)
  demo    Seed demo data if available
  keys    Generate QUERY/INGEST secrets in .env if missing
EOF
}

read_env_value() {
  local key="$1"
  local default_value="$2"
  if [[ -f .env ]]; then
    local line
    line="$(grep -E "^${key}=" .env | tail -n 1 || true)"
    if [[ -n "$line" ]]; then
      echo "${line#*=}"
      return
    fi
  fi
  echo "$default_value"
}

require_compose() {
  command -v docker >/dev/null 2>&1 || die "docker is required"
  "${COMPOSE[@]}" version >/dev/null 2>&1 || die "docker compose (v2) is required"
}

ensure_env_file() {
  if [[ -f .env ]]; then
    return
  fi
  if [[ -f .env.example ]]; then
    cp .env.example .env
    echo "Created .env from .env.example"
  else
    touch .env
    echo "Created empty .env"
  fi
}

cmd_up() {
  require_compose
  ensure_env_file
  "${COMPOSE[@]}" up -d --build
  local api_port
  local frontend_port
  api_port="$(read_env_value API_PORT 3000)"
  frontend_port="$(read_env_value FRONTEND_PORT 5173)"
  echo ""
  echo "Stack is up."
  echo "Backend API:  http://localhost:${api_port}"
  echo "Health:       http://localhost:${api_port}/health"
  echo "Readiness:    http://localhost:${api_port}/readyz"
  echo "Frontend UI:  http://localhost:${frontend_port}"
}

cmd_down() {
  require_compose
  "${COMPOSE[@]}" down
}

cmd_logs() {
  require_compose
  "${COMPOSE[@]}" logs -f --tail=200
}

cmd_ps() {
  require_compose
  "${COMPOSE[@]}" ps
}

cmd_reset() {
  require_compose
  echo "Resetting stack (containers + volumes)..."
  "${COMPOSE[@]}" down -v
}

cmd_demo() {
  require_compose
  ensure_env_file

  if [[ -f scripts/seed-data.ts ]]; then
    "${COMPOSE[@]}" up -d --build postgres migrate
    echo "Seeding demo data with scripts/seed-data.ts ..."
    "${COMPOSE[@]}" run --rm -e NODE_ENV=development backend npx ts-node scripts/seed-data.ts --db
    echo "Demo seed complete."
    return
  fi

  if [[ -f scripts/simulate-walk.ts ]]; then
    echo "Found scripts/simulate-walk.ts (requires an INGEST API key)."
    echo "Run: npm run simulate:walk -- --apiKey YOUR_KEY --deviceUid dev-1 --baseLat 37.77 --baseLon -122.43 --minutes 15 --intervalSec 5 --seed demo"
    return
  fi

  die "no demo/seed script found"
}

cmd_keys() {
  if [[ -x "$ROOT_DIR/scripts/setup/generate-secrets.sh" ]]; then
    "$ROOT_DIR/scripts/setup/generate-secrets.sh"
    return
  fi
  if [[ -f "$ROOT_DIR/scripts/setup/generate-secrets.js" ]]; then
    node "$ROOT_DIR/scripts/setup/generate-secrets.js"
    return
  fi
  die "missing scripts/setup/generate-secrets script"
}

main() {
  local cmd="${1:-help}"
  case "$cmd" in
    up) cmd_up ;;
    down) cmd_down ;;
    logs) cmd_logs ;;
    ps) cmd_ps ;;
    reset) cmd_reset ;;
    demo) cmd_demo ;;
    keys) cmd_keys ;;
    help|-h|--help) usage ;;
    *) usage; die "unknown command: $cmd" ;;
  esac
}

main "$@"
